# Breadcrumb Format and Field Order Issues - December 18, 2025

## Issue 1: Breadcrumb Format Regression

### Problem
Breadcrumbs are being generated with wrong format:
- **Current (WRONG)**: `breadcrumb_text: "Home / Materials / stone / Alabaster"` (simple text string)
- **Expected (CORRECT)**: Array of objects with `label` and `href` fields

### Example of Correct Format
```yaml
breadcrumb:
  - label: Home
    href: /
  - label: Materials
    href: /materials
  - label: Stone
    href: /materials/stone
  - label: Alabaster
    href: /materials/stone/alabaster
```

### Root Cause
The `BreadcrumbGenerator` in `export/generation/registry.py` generates simple text strings using a template, which is overwriting the proper array structure generated by `TrivialFrontmatterExporter._generate_breadcrumb()`.

**File**: `export/generation/registry.py` lines 154-210
```python
class BreadcrumbGenerator(BaseGenerator):
    def generate(self, frontmatter: Dict[str, Any]) -> Dict[str, Any]:
        # WRONG: Creates text string
        breadcrumb = self.template.format(**frontmatter)
        frontmatter[self.output_field] = breadcrumb
```

**Configs using wrong generator**:
- `export/config/materials.yaml` line 92-94
- `export/config/contaminants.yaml` line 80-82
- `export/config/compounds.yaml` line 75-77
- `export/config/settings.yaml` line 77-79

### Solution

**Option A: Remove BreadcrumbGenerator from Configs** (RECOMMENDED)
Remove the breadcrumb generator step from all export configs since `TrivialFrontmatterExporter` already generates proper breadcrumbs.

**Option B: Fix BreadcrumbGenerator**
Rewrite `BreadcrumbGenerator` to generate array of objects instead of text string.

**Option C: Disable in UniversalExporter**
Don't use UniversalExporter's BreadcrumbGenerator, rely only on TrivialFrontmatterExporter.

### Files Affected
- ❌ 152 materials files: All have `breadcrumb_text` instead of `breadcrumb` array
- ❌ 97 contaminants files: Same issue
- ❌ 20 compounds files: Same issue
- ❌ 153 settings files: Same issue
- **Total**: 422 files need regeneration

### Action Items
1. ✅ Remove breadcrumb generator from all 4 export configs
2. ✅ Regenerate all frontmatter files:
   ```bash
   cd /Users/todddunning/Desktop/Z-Beam/z-beam && python3 -m app.scripts.regenerate-all-frontmatter
   ```
3. ✅ Verify breadcrumb structure in generated files
4. ✅ Test in website to ensure breadcrumb navigation works

---

## Issue 2: Field Order Normalization

### Purpose
Ensure consistent field order across all frontmatter files according to `data/schemas/FrontmatterFieldOrder.yaml`.

### Validation Commands

**Check single domain**:
```python
from shared.validation.field_order import FrontmatterFieldOrderValidator
validator = FrontmatterFieldOrderValidator()
validator.load_schema()

# Validate materials
results = validator.validate_domain('materials')
print(f"Valid: {results['valid_count']}/{results['total_count']}")
print(f"Invalid files: {results['invalid_files']}")
```

**Check all domains**:
```bash
# Materials
python3 -c "from shared.validation.field_order import FrontmatterFieldOrderValidator; v = FrontmatterFieldOrderValidator(); v.load_schema(); r = v.validate_domain('materials'); print(f\"Materials: {r['valid_count']}/{r['total_count']} valid\")"

# Contaminants
python3 -c "from shared.validation.field_order import FrontmatterFieldOrderValidator; v = FrontmatterFieldOrderValidator(); v.load_schema(); r = v.validate_domain('contaminants'); print(f\"Contaminants: {r['valid_count']}/{r['total_count']} valid\")"

# Compounds
python3 -c "from shared.validation.field_order import FrontmatterFieldOrderValidator; v = FrontmatterFieldOrderValidator(); v.load_schema(); r = v.validate_domain('compounds'); print(f\"Compounds: {r['valid_count']}/{r['total_count']} valid\")"

# Settings
python3 -c "from shared.validation.field_order import FrontmatterFieldOrderValidator; v = FrontmatterFieldOrderValidator(); v.load_schema(); r = v.validate_domain('settings'); print(f\"Settings: {r['valid_count']}/{r['total_count']} valid\")"
```

### Reorder Files (if needed)

**Reorder single domain** (dry run first):
```python
from shared.validation.field_order import FrontmatterFieldOrderValidator
validator = FrontmatterFieldOrderValidator()
validator.load_schema()

# Dry run first
results = validator.reorder_domain('materials', dry_run=True)
print(f"Would reorder: {results['reordered_count']} files")

# Actually reorder
results = validator.reorder_domain('materials', dry_run=False)
print(f"Reordered: {results['reordered_count']} files")
```

### Expected Field Order

**Materials**:
1. id
2. name
3. slug
4. category
5. subcategory
6. content_type
7. schema_version
8. datePublished
9. dateModified
10. author
11. title
12. description
13. images
14. micro
15. faq
16. applications
17. properties (machine_settings, characteristics, surface_texture)
18. relationships
19. seo_description
20. breadcrumb

**Contaminants**:
1. id
2. name
3. slug
4. category
5. subcategory
6. content_type
7. schema_version
8. datePublished
9. dateModified
10. author
11. title
12. description
13. images
14. faq
15. relationships
16. seo_description
17. breadcrumb

---

## Execution Plan

### Step 1: Fix Breadcrumb Generation ⏳

**1a. Remove breadcrumb generators from configs**
```bash
cd /Users/todddunning/Desktop/Z-Beam/z-beam-generator
# Edit these files to remove breadcrumb generator sections:
# - export/config/materials.yaml (lines 91-94)
# - export/config/contaminants.yaml (lines 79-82)
# - export/config/compounds.yaml (lines 74-77)
# - export/config/settings.yaml (lines 76-79)
```

**1b. Regenerate all frontmatter**
```bash
cd /Users/todddunning/Desktop/Z-Beam/z-beam
python3 -m app.scripts.regenerate-all-frontmatter
```

**1c. Verify breadcrumb structure**
```bash
cd /Users/todddunning/Desktop/Z-Beam/z-beam/frontmatter/materials
head -50 alabaster-laser-cleaning.yaml | grep -A 20 "breadcrumb:"
# Should show array of objects, not breadcrumb_text
```

### Step 2: Validate Field Order ⏳

**2a. Check current status**
```bash
cd /Users/todddunning/Desktop/Z-Beam/z-beam-generator
python3 scripts/validate_field_order_all.py  # Create this script if needed
```

**2b. Reorder if needed**
```bash
python3 scripts/reorder_field_order_all.py  # Create this script if needed
```

### Step 3: Commit Changes ⏳

```bash
cd /Users/todddunning/Desktop/Z-Beam/z-beam-generator
git add export/config/*.yaml
git commit -m "Fix breadcrumb generation: remove text-based generator

Breadcrumbs should be arrays of {label, href} objects, not text strings.
TrivialFrontmatterExporter already generates proper structure.

- Removed breadcrumb generator from materials.yaml
- Removed breadcrumb generator from contaminants.yaml
- Removed breadcrumb generator from compounds.yaml
- Removed breadcrumb generator from settings.yaml

Requires frontmatter regeneration to apply fix."

cd /Users/todddunning/Desktop/Z-Beam/z-beam
git add frontmatter/
git commit -m "Regenerate all frontmatter with correct breadcrumb structure

Fixed breadcrumb format from text string to array of objects:
- Before: breadcrumb_text: 'Home / Materials / stone / Alabaster'
- After: breadcrumb: [{label: Home, href: /}, {label: Materials, href: /materials}, ...]

All 422 files regenerated:
- 152 materials
- 97 contaminants
- 20 compounds
- 153 settings"
```

---

## Testing Checklist

After regeneration, verify:

- [ ] Materials breadcrumb is array with label/href
- [ ] Contaminants breadcrumb is array with label/href
- [ ] Compounds breadcrumb is array with label/href
- [ ] Settings breadcrumb is array with label/href
- [ ] No `breadcrumb_text` field exists anywhere
- [ ] Field order matches specification
- [ ] Website breadcrumb navigation works
- [ ] All 422 files validated successfully

---

## Historical Context

**Correct Implementation** (commit f21290710):
- `_generate_breadcrumb()` in `TrivialFrontmatterExporter`
- Generates array of objects with label/href
- Used for all 4 domains

**Regression** (recent commit):
- Added `BreadcrumbGenerator` to UniversalExporter pipeline
- Configured with simple text template
- Overwrote proper breadcrumb arrays with text strings

**Related Commits**:
- 29e451c9: "Update schemas, tests, and docs for breadcrumb changes"
- 1285292c: "Fix contaminants breadcrumb URL structure"
- d34d915e: "Fix breadcrumb hrefs: Use singular category names"

---

**Status**: Ready for fix implementation
**Priority**: HIGH - Affects all 422 frontmatter files
**Impact**: Website breadcrumb navigation currently broken/degraded
