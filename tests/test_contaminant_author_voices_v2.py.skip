#!/usr/bin/env python3
"""
Test Contaminant Generation with Different Authors

Tests voice consistency by generating contaminant micros (subtitles) with all 4 authors.
Uses the actual contaminant generation pipeline.
"""

import sys
from pathlib import Path

# Add project root to path
sys.path.insert(0, str(Path(__file__).parent))

from shared.api.client_factory import APIClientFactory
from shared.api.client import GenerationRequest
from generation.config.dynamic_config import DynamicConfig
from data.authors.registry import get_author


def test_contaminant_with_author(pattern_id: str, author_id: int):
    """Generate contaminant micro with specific author"""
    
    # Get real author from registry
    author = get_author(author_id)
    author_name = author['name']
    author_country = author['country']
    
    print(f"\n{'='*80}")
    print(f"üß™ GENERATING CONTAMINANT: {pattern_id}")
    print(f"üë§ AUTHOR: {author_id} - {author_name} ({author_country})")
    print(f"{'='*80}\n")
    
    # Create API client
    api_client = APIClientFactory.create_client('grok')
    
    # Create dynamic config
    dynamic_config = DynamicConfig()
    
    # Get generation parameters
    params = dynamic_config.get_all_generation_params('caption')  # micros are captions
    temperature = params.get('temperature', 0.8)
    
    print("üå°Ô∏è  Generation Parameters:")
    print(f"   ‚Ä¢ temperature: {temperature}")
    
    # Build prompt for contaminant micro
    # Using simple direct prompt for testing
    prompt = f"""Generate a brief subtitle/micro description for this contamination pattern:

Pattern: {pattern_id.replace('_', ' ').title()}
Component Type: Subtitle (micro)
Length: 40-80 words maximum
Author Voice ID: {author_id}

Write ONLY the subtitle text - no quotes, no explanations, no formatting."""
    
    print("\nüé® Generating content...")
    
    # Create generation request
    request = GenerationRequest(
        prompt=prompt,
        temperature=temperature,
        max_tokens=200
    )
    
    # Generate
    response = api_client.generate(request)
    
    content = response.content.strip() if response and response.success else ""
    
    # Display results
    print(f"\n‚úÖ GENERATION SUCCESSFUL")
    print(f"\nüìù GENERATED CONTENT:")
    print(f"{'‚îÄ'*80}")
    print(content)
    print(f"{'‚îÄ'*80}")
    
    print(f"\nüìä METRICS:")
    print(f"   ‚Ä¢ Length: {len(content)} chars")
    print(f"   ‚Ä¢ Words: {len(content.split())} words")
    print(f"   ‚Ä¢ Author: {author_name}")
    
    return {
        'success': True,
        'content': content,
        'author_id': author_id,
        'author_name': author_name,
        'length': len(content),
        'word_count': len(content.split())
    }


def main():
    """Test all 4 authors with different contaminant patterns"""
    
    print("\n" + "="*80)
    print("üé≠ CONTAMINANT VOICE CONSISTENCY TEST")
    print("Testing all 4 author personas with different contamination patterns")
    print("="*80)
    
    # Test cases: (pattern_id, author_id)
    # Using REAL authors from data/authors/registry.py
    test_cases = [
        ("rust_oxidation", 1),        # Yi-Chun Lin (Taiwan)
        ("paint_coating", 2),          # Alessandro Moretti (Italy)
        ("oil_grease", 3),             # Ikmanda Roswati (Indonesia)
        ("biological_growth", 4)       # Todd Dunning (United States)
    ]
    
    results = []
    for pattern_id, author_id in test_cases:
        try:
            result = test_contaminant_with_author(pattern_id, author_id)
            results.append(result)
        except Exception as e:
            print(f"\n‚ùå ERROR for {pattern_id}: {str(e)}")
            import traceback
            traceback.print_exc()
    
    # Summary
    print(f"\n{'='*80}")
    print("üìä SUMMARY")
    print(f"{'='*80}")
    print(f"Total tests: {len(test_cases)}")
    print(f"Successful: {len([r for r in results if r['success']])}")
    print("\n‚ú® Voice Consistency Check:")
    for result in results:
        author = get_author(result['author_id'])
        print(f"   ‚Ä¢ Author {result['author_id']}: {result['word_count']} words - {author['name']} ({author['country']})")
    print(f"{'='*80}\n")


if __name__ == "__main__":
    main()
